<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PJOK - APLIKASI PEMBUAT SOAL STS/SAS/US 2025/2026</title>
    <script src="https://unpkg.com/docx@7.1.1/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        /* --- TEMA PREMIUM CLEAN --- */
        :root { 
            --primary-grad: linear-gradient(135deg, #2563eb, #3b82f6); 
            --accent: #2563eb; 
            --success: #10b981; 
            --danger: #ef4444; 
            --bg-body: #f1f5f9;
            --text-dark: #1e293b;
        }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, sans-serif; 
            background: var(--bg-body); 
            margin: 0; 
            padding: 20px;
            color: var(--text-dark);
        }

        .container { 
            max-width: 1280px; 
            margin: auto; 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
            overflow: hidden; 
            border: 1px solid #e2e8f0;
        }
        
        header { 
            background: var(--primary-grad); 
            color: white; 
            padding: 20px 30px; 
            position: relative; 
            border-bottom: 4px solid rgba(255,255,255,0.2);
        }

        .marquee-container {
            background: #1e293b;
            color: #fbbf24;
            padding: 8px 0;
            font-size: 14px;
            font-weight: 800;
            letter-spacing: 2px;
            border-bottom: 1px solid #334155;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-content h1 { margin: 0; font-size: 22px; font-weight: 700; }
        
        .top-right-badge { display: flex; align-items: center; gap: 10px; }

        .creator-name { 
            font-size: 11px; font-weight: 600; color: #ffffff; 
            background: rgba(255, 255, 255, 0.15); padding: 4px 12px; border-radius: 15px;
        }

        .online-badge { 
            display: inline-flex; align-items: center; gap: 5px; font-size: 10px; 
            background: rgba(0,0,0,0.1); padding: 4px 8px; border-radius: 12px;
        }
        .dot { width: 6px; height: 6px; border-radius: 50%; }
        .online .dot { background: #4ade80; }
        .offline .dot { background: #f87171; }

        .tab-nav { display: flex; background: #fff; padding: 0 20px; border-bottom: 1px solid #e2e8f0; }
        .tab-btn { 
            padding: 15px 20px; border: none; background: none; cursor: pointer; 
            font-weight: 600; color: #64748b; font-size: 13px; position: relative;
        }
        .tab-btn.active { color: var(--accent); }
        .tab-btn.active::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: var(--accent);
        }

        .content { padding: 25px 30px; }
        
        .filter-bar { 
            background: #fff; border: 1px solid #e2e8f0; padding: 15px; 
            border-radius: 8px; margin-bottom: 20px; display: flex; 
            align-items: center; justify-content: space-between; gap: 15px;
        }
        .filter-select { padding: 8px 12px; border-radius: 6px; border: 1px solid #cbd5e1; font-weight: 600; min-width: 200px; }

        .card { background: #fff; border: 1px solid #e2e8f0; padding: 20px; border-radius: 10px; margin-bottom: 20px; }

        .btn { 
            padding: 8px 15px; border-radius: 6px; border: none; cursor: pointer; 
            font-weight: 600; color: white; font-size: 12px; display: inline-flex; align-items: center; gap: 6px; 
        }
        .btn-blue { background: #3b82f6; } 
        .btn-green { background: #10b981; }
        .btn-red { background: #ef4444; } 
        .btn-dark { background: #334155; }
        .btn-orange { background: #f59e0b; } 
        .btn-purple { background: #8b5cf6; }
        
        .print-group { display: flex; align-items: center; gap: 8px; background: #f8fafc; padding: 5px 10px; border-radius: 8px; border: 1px solid #e2e8f0; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 12px; color: #475569; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 13px; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 15px; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
        th { background: #f8fafc; font-weight: 700; color: #475569; font-size: 11px; border-bottom: 1px solid #e2e8f0; padding: 12px 15px; text-align: left; }
        td { border-bottom: 1px solid #e2e8f0; color: #334155; padding: 12px 15px; font-size: 13px; }

        .hidden { display: none !important; }
        .preview-img { max-height: 100px; margin-top: 8px; display: block; border-radius: 4px; border: 1px solid #cbd5e1; }
        .section-title { font-size: 13px; font-weight: 800; color: var(--accent); border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; margin-bottom: 15px; text-transform: uppercase; }
        
        .soal-item { display: flex; align-items: flex-start; gap: 15px; margin-bottom: 10px; }
        .soal-number { font-weight: bold; min-width: 25px; color: var(--accent); }
        .soal-image-container img { width: 100%; border-radius: 6px; border: 1px solid #e2e8f0; }

        .rekap-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 10px; }
        .rekap-card { padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #e2e8f0; }
        .rekap-val { font-size: 20px; font-weight: 800; }
        .rekap-label { font-size: 10px; font-weight: bold; color: #64748b; }

        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.98); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 40px; border-radius: 15px; width: 100%; max-width: 380px; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <div style="text-align:center; margin-bottom:25px;">
            <h2 style="margin:0; color:#1e293b; font-size:22px;">ADMIN/GURU LOGIN</h2>
            <p style="color:#64748b; font-size:13px;">Aplikasi Pembuat Soal PJOK</p>
        </div>
        <div class="form-group">
            <label>Email Akun</label>
            <input type="email" id="loginEmail" placeholder="Masukkan email...">
        </div>
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="loginPass" placeholder="******">
        </div>
        <button class="btn btn-blue" style="width:100%; padding:12px; justify-content:center;" onclick="handleLogin()">MASUK KE SISTEM</button>
        <div id="loginError" style="color:#ef4444; font-size:12px; margin-top:15px; text-align:center;"></div>
    </div>
</div>

<div class="container">
    <header>
        <div class="header-content">
            <div>
                <h1>TIM KKGO KECAMATAN MAJALENGKA</h1>
                <p>Aplikasi Pembuat Soal STS/SAS/US 2025/2026</p>
            </div>
            <div class="top-right-badge">
                <div class="creator-name" id="displayUserName">Memuat...</div>
                <button class="btn btn-red" onclick="handleLogout()" style="padding:4px 8px; font-size:10px;">LOGOUT</button>
                <div id="statusIndicator" class="online-badge offline"><div class="dot"></div> <span id="statusText">Connecting...</span></div>
            </div>
        </div>
    </header>

    <div class="marquee-container">
        <marquee behavior="scroll" direction="left">‚ú® MAJALENGKA LANGKUNG SAE ‚Äî TIM KKGO KECAMATAN MAJALENGKA ‚Äî SEMANGAT MENCERDASKAN ANAK BANGSA ‚ú®</marquee>
    </div>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab(event, 'kurikulum')">üìÇ DATA KURIKULUM</button>
        <button class="tab-btn" onclick="switchTab(event, 'banksoal')">üìù BANK SOAL</button>
        <button class="tab-btn" onclick="switchTab(event, 'tabUS')">üéì UJIAN SEKOLAH (US)</button>
        <button class="tab-btn hidden" id="btnTabUser" onclick="switchTab(event, 'tabUser')">üë§ KELOLA GURU</button>
    </div>

    <div class="content">
        <div class="filter-bar">
            <div style="display:flex; align-items:center; gap:12px;">
                <span style="font-size:20px;">üéØ</span>
                <div>
                    <div style="font-size:10px; font-weight:bold; color:#64748b;">Mode Fokus Kelas:</div>
                    <select id="mainFilterKelas" class="filter-select" onchange="applyFilter()">
                        <option value="ALL">üìÇ TAMPILKAN SEMUA</option>
                        <option value="1">KELAS 1 (Fase A)</option>
                        <option value="2">KELAS 2 (Fase A)</option>
                        <option value="3">KELAS 3 (Fase B)</option>
                        <option value="4">KELAS 4 (Fase B)</option>
                        <option value="5">KELAS 5 (Fase C)</option>
                        <option value="6">KELAS 6 (Fase C)</option>
                    </select>
                </div>
            </div>
            <div id="adminLogoBar">
                <input type="file" id="fLogoInstansi" accept="image/*" onchange="saveLogoToLocal(this)" style="font-size: 11px;">
                <div id="pvLogoKop" style="width:40px; height:40px; border:1px solid #ccc; display:inline-block; vertical-align:middle;"></div>
            </div>
        </div>

        <div id="kurikulum" class="tab-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0; font-size:18px;">Repositori CP & TP</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-purple" onclick="exportWord('tp')">üìÑ CETAK TP</button>
                    <button class="btn btn-green" onclick="openFormKur()">‚ûï TAMBAH DATA</button>
                </div>
            </div>
            <div id="formKur" class="card hidden">
                <input type="hidden" id="editKurId">
                <div class="section-title">Form Data Kurikulum</div>
                <div class="grid-3">
                    <div class="form-group"><label>Fase</label><select id="fFase"><option>A</option><option>B</option><option>C</option></select></div>
                    <div class="form-group"><label>Kelas</label><select id="fKelas"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select></div>
                    <div class="form-group"><label>Semester</label><select id="fSem"><option>1</option><option>2</option></select></div>
                </div>
                <div class="form-group"><label>Capaian Pembelajaran (CP)</label><textarea id="fCp" rows="2"></textarea></div>
                <div class="form-group"><label>Tujuan Pembelajaran (TP)</label><div id="tpInputs"></div></div>
                <button class="btn btn-blue" onclick="addTPField('')">+ TAMBAH BARIS TP</button>
                <div style="text-align:right; margin-top:20px;">
                    <button class="btn btn-dark" onclick="closeForm('formKur')">BATAL</button>
                    <button class="btn btn-green" onclick="saveKur()">SIMPAN KE CLOUD</button>
                </div>
            </div>
            <table>
                <thead><tr><th>Kelas</th><th>Sem</th><th>CP</th><th>Daftar TP</th><th width="120">Aksi</th></tr></thead>
                <tbody id="tblKurBody"></tbody>
            </table>
        </div>

        <div id="formSoal" class="card hidden">
            <input type="hidden" id="editSoalId">
            <input type="hidden" id="sKategori" value="REGULER">
            <div class="section-title">1. Identitas Soal <span id="labelKategori" style="float:right; color:#ef4444;"></span></div>
            <div class="grid-3">
                <div class="form-group"><label>Tipe Soal</label><select id="sType" onchange="checkSoalType()"><option value="PG">Pilihan Ganda</option><option value="Essay">Essay / Uraian</option></select></div>
                <div class="form-group"><label>Kelas</label><select id="sKelas" onchange="loadTP()"></select></div>
                <div class="form-group"><label>Pilih TP</label><select id="sTP"></select></div>
            </div>

            <div class="section-title">2. Detail Akademik</div>
            <div class="grid-2">
                <div class="form-group"><label>Materi Pokok</label><input type="text" id="sMateri"></div>
                <div class="form-group"><label>Indikator Soal</label><input type="text" id="sIndikator"></div>
            </div>

            <div class="section-title">3. Konten Soal</div>
            <div class="form-group">
                <label>Pertanyaan</label>
                <textarea id="sTanya" rows="3"></textarea>
                <input type="file" id="fImgS" onchange="showPv(this, 'pvS')" style="margin-top:10px;">
                <div id="pvS"></div>
            </div>

            <div id="essayBox" class="hidden form-group">
                <label>KUNCI JAWABAN ESSAY</label>
                <textarea id="sJawabanEssay" rows="3"></textarea>
            </div>
            
            <div id="pgBox">
                <div class="grid-2">
                    <div class="form-group"><label>Opsi A</label><input type="text" id="oa"><input type="file" onchange="showPv(this, 'pa')"><div id="pa"></div></div>
                    <div class="form-group"><label>Opsi B</label><input type="text" id="ob"><input type="file" onchange="showPv(this, 'pb')"><div id="pb"></div></div>
                    <div class="form-group" id="rowC"><label>Opsi C</label><input type="text" id="oc"><input type="file" onchange="showPv(this, 'pc')"><div id="pc"></div></div>
                    <div class="form-group" id="rowD"><label>Opsi D</label><input type="text" id="od"><input type="file" onchange="showPv(this, 'pd')"><div id="pd"></div></div>
                </div>
                <div class="form-group">
                    <label>Kunci Jawaban</label>
                    <select id="sKunci" style="width:150px;"></select>
                </div>
            </div>
            
            <div style="text-align:right; margin-top:20px;">
                <button class="btn btn-dark" onclick="closeForm('formSoal')">BATAL</button>
                <button class="btn btn-blue" id="btnSaveSoal" onclick="saveSoal()">üíæ SIMPAN SOAL</button>
            </div>
        </div>

        <div id="banksoal" class="tab-content hidden">
            <div id="rekapStats" class="card"></div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0; font-size:18px;">Bank Soal Digital</h2>
                <div class="print-group">
                    <button class="btn btn-green" onclick="openFormSoal('REGULER')">‚ûï SOAL BARU</button>
                    <button class="btn btn-blue" onclick="exportWord('soal_only')">üìÑ CETAK SOAL</button>
                    <button class="btn btn-orange" onclick="exportWord('kisi_only')">üìã KISI-KISI</button>
                    <button class="btn btn-dark" onclick="exportWord('kunci_only')">üîë KUNCI</button>
                </div>
            </div>
            <div id="soalContainer" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap:20px;"></div>
        </div>

        <div id="tabUS" class="tab-content hidden">
            <div id="rekapStatsUS" class="card"></div>
            <div class="card">
                <h2>Modul Ujian Sekolah (US)</h2>
                <button class="btn btn-purple" onclick="openFormSoal('US')">‚ûï TAMBAH SOAL US</button>
                <button class="btn btn-blue" onclick="exportWord('us_soal')">üìÑ CETAK US</button>
            </div>
            <div id="usSoalContainer" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap:20px;"></div>
        </div>

        <div id="tabUser" class="tab-content hidden">
            <div class="card">
                <div class="section-title">Kelola Guru</div>
                <div class="grid-3">
                    <input type="email" id="regEmail" placeholder="Email Guru">
                    <input type="password" id="regPass" placeholder="Password">
                    <select id="regKelas"><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option></select>
                </div>
                <button class="btn btn-green" onclick="registerGuru()" style="margin-top:10px;">DAFTARKAN</button>
            </div>
            <table>
                <thead><tr><th>Email</th><th>Kelas</th><th>Aksi</th></tr></thead>
                <tbody id="tblUserBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, update, onValue, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD3QnhV3PzzCKYxpt2JMapdhCZADApAmic",
        authDomain: "pjok-majalengka.firebaseapp.com",
        databaseURL: "https://pjok-majalengka-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "pjok-majalengka",
        storageBucket: "pjok-majalengka.firebasestorage.app",
        messagingSenderId: "996966252466",
        appId: "1:996966252466:web:182de1ccd581fe0747aeab"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let KUR_DB = [];
    let SOAL_DB = [];
    let userAksesKelas = null;

    // --- AUTH ---
    window.handleLogin = function() {
        const email = document.getElementById('loginEmail').value;
        const pass = document.getElementById('loginPass').value;
        signInWithEmailAndPassword(auth, email, pass).catch(err => alert("Login Gagal"));
    };

    window.handleLogout = function() { signOut(auth); };

    onAuthStateChanged(auth, (user) => {
        const overlay = document.getElementById('loginOverlay');
        if (user) {
            overlay.style.display = 'none';
            const userId = btoa(user.email).replace(/=/g, "");
            onValue(ref(db, 'users/' + userId), (snap) => {
                const ud = snap.val();
                if(ud && ud.role === "GURU") {
                    userAksesKelas = ud.aksesKelas;
                    document.getElementById('displayUserName').innerText = "Guru Kls " + userAksesKelas;
                    document.getElementById('mainFilterKelas').value = userAksesKelas;
                    document.getElementById('mainFilterKelas').disabled = true;
                    document.getElementById('btnTabUser').classList.add('hidden');
                } else {
                    document.getElementById('displayUserName').innerText = "Administrator";
                    document.getElementById('btnTabUser').classList.remove('hidden');
                }
                applyFilter();
            });
        } else { overlay.style.display = 'flex'; }
    });

    // --- CORE LOGIC ---
    onValue(ref(db, 'kurikulum'), (s) => { KUR_DB = s.val() ? Object.values(s.val()) : []; renderKur(); populateKelas(); });
    onValue(ref(db, 'soal'), (s) => { SOAL_DB = s.val() ? Object.values(s.val()) : []; renderSoal(); });

    window.switchTab = function(e, n) {
        document.querySelectorAll('.tab-content').forEach(x => x.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
        document.getElementById(n).classList.remove('hidden');
        e.currentTarget.classList.add('active');
    };

    window.closeForm = function(id) { document.getElementById(id).classList.add('hidden'); };

    window.applyFilter = function() { renderKur(); renderSoal(); };

    window.populateKelas = function() {
        const s = document.getElementById('sKelas');
        s.innerHTML = "<option value=''>- Pilih Kelas -</option>";
        [1,2,3,4,5,6].forEach(k => s.innerHTML += `<option value="${k}">${k}</option>`);
    };

    // LOGIKA PENTING: Sembunyikan Opsi D untuk Kelas 1 & 2
    window.loadTP = function() {
        const k = document.getElementById('sKelas').value;
        const sTP = document.getElementById('sTP');
        sTP.innerHTML = "";
        KUR_DB.filter(x => x.rombel == k).forEach(d => (d.tpSet||[]).forEach(t => sTP.innerHTML += `<option value="${t}">${t}</option>`));
        
        const isKecil = (k == "1" || k == "2");
        document.getElementById('rowD').classList.toggle('hidden', isKecil);
        
        const kunci = document.getElementById('sKunci');
        kunci.innerHTML = `<option value="a">A</option><option value="b">B</option><option value="c">C</option>`;
        if(!isKecil) kunci.innerHTML += `<option value="d">D</option>`;
    };

    window.checkSoalType = function() {
        const t = document.getElementById('sType').value;
        document.getElementById('pgBox').classList.toggle('hidden', t === 'Essay');
        document.getElementById('essayBox').classList.toggle('hidden', t !== 'Essay');
    };

    window.openFormSoal = function(kat = 'REGULER') {
        document.getElementById('editSoalId').value = "";
        document.getElementById('sKategori').value = kat;
        document.getElementById('formSoal').classList.remove('hidden');
        if(userAksesKelas) {
            document.getElementById('sKelas').value = userAksesKelas;
            document.getElementById('sKelas').disabled = true;
        }
        loadTP();
    };

    window.saveSoal = async function() {
        const id = document.getElementById('editSoalId').value || Date.now();
        const k = document.getElementById('sKelas').value;
        const s = {
            id: id, kelas: k, tipe: document.getElementById('sType').value,
            kategori: document.getElementById('sKategori').value,
            tp: document.getElementById('sTP').value, materi: document.getElementById('sMateri').value,
            tanya: document.getElementById('sTanya').value, kunci: document.getElementById('sKunci').value,
            jawaban: document.getElementById('sJawabanEssay').value, level: "L1",
            opsi: [
                { t: document.getElementById('oa').value },
                { t: document.getElementById('ob').value },
                { t: document.getElementById('oc').value }
            ]
        };
        // Hanya simpan Opsi D jika bukan kelas 1 atau 2
        if(k != "1" && k != "2") s.opsi.push({ t: document.getElementById('od').value });
        
        await set(ref(db, 'soal/' + id), s);
        alert("Simpan Berhasil");
        closeForm('formSoal');
    };

    window.renderSoal = function() {
        const container = document.getElementById('soalContainer');
        container.innerHTML = "";
        const f = document.getElementById('mainFilterKelas').value;
        let data = SOAL_DB;
        if(f !== 'ALL') data = data.filter(x => x.kelas == f);
        
        data.forEach(s => {
            container.innerHTML += `<div class="card">
                <small>Kls ${s.kelas} | ${s.tipe}</small><br><b>${s.tanya}</b>
                <div style="margin-top:10px;">
                    <button class="btn btn-orange" onclick="editSoal('${s.id}')">EDIT</button>
                    <button class="btn btn-red" onclick="hapusSoal('${s.id}')">HAPUS</button>
                </div>
            </div>`;
        });
    };

    window.editSoal = function(id) {
        const s = SOAL_DB.find(x => x.id == id);
        if(!s) return;
        document.getElementById('editSoalId').value = s.id;
        document.getElementById('sKelas').value = s.kelas;
        loadTP();
        document.getElementById('sType').value = s.tipe;
        document.getElementById('sTanya').value = s.tanya;
        document.getElementById('oa').value = s.opsi[0]?.t || "";
        document.getElementById('ob').value = s.opsi[1]?.t || "";
        document.getElementById('oc').value = s.opsi[2]?.t || "";
        if(s.kelas != "1" && s.kelas != "2") document.getElementById('od').value = s.opsi[3]?.t || "";
        document.getElementById('formSoal').classList.remove('hidden');
        checkSoalType();
    };

    window.hapusSoal = function(id) { if(confirm("Hapus?")) remove(ref(db, 'soal/'+id)); };

    // --- WORD EXPORT LOGIC ---
    window.exportWord = function(mode) {
        const { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell, WidthType, BorderStyle, AlignmentType } = docx;
        const filterVal = document.getElementById('mainFilterKelas').value;
        let dataExport = (filterVal === 'ALL') ? SOAL_DB : SOAL_DB.filter(x => x.kelas == filterVal);
        
        if(dataExport.length === 0) return alert("Kosong");

        const sections = [];
        const classes = [...new Set(dataExport.map(x => x.kelas))].sort();

        classes.forEach(cls => {
            const isKecil = (cls == "1" || cls == "2");
            const children = [new Paragraph({ children: [new TextRun({ text: "SOAL PJOK KELAS " + cls, bold: true, size: 28 })], alignment: AlignmentType.CENTER })];
            
            const soals = dataExport.filter(x => x.kelas == cls);
            soals.forEach((s, i) => {
                children.push(new Paragraph({ text: "", spacing: { before: 200 } }));
                children.push(new Paragraph({ children: [new TextRun({ text: `${i+1}. ${s.tanya}`, size: 24 })] }));
                
                if(s.tipe === 'PG') {
                    const abc = ['a', 'b', 'c', 'd'];
                    // LOGIKA PENTING: Batasi opsi hanya sampai 3 (index 2) untuk kelas 1 & 2
                    const limit = isKecil ? 3 : (s.opsi ? s.opsi.length : 0);
                    
                    for(let j=0; j<limit; j++) {
                        if(s.opsi[j]) {
                            children.push(new Paragraph({ 
                                children: [new TextRun({ text: `   ${abc[j]}. ${s.opsi[j].t}`, size: 24 })] 
                            }));
                        }
                    }
                }
            });

            sections.push({ children });
        });

        const doc = new Document({ sections });
        Packer.toBlob(doc).then(blob => saveAs(blob, `Soal_PJOK.docx`));
    };

    // Placeholder functions for Kurikulum & User
    window.openFormKur = () => document.getElementById('formKur').classList.remove('hidden');
    window.addTPField = (v) => { document.getElementById('tpInputs').insertAdjacentHTML('beforeend', `<input type="text" class="tp-val" value="${v}" style="margin-bottom:5px;">`); };
    window.saveKur = () => { /* logic simpan kurikulum */ closeForm('formKur'); };
    window.renderKur = () => { /* logic render tabel kurikulum */ };

</script>
</body>
</html>
