<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PJOK - APLIKASI PEMBUAT SOAL PRO 2026</title>
    
    <script src="https://unpkg.com/docx@7.1.1/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        :root { 
            --primary-grad: linear-gradient(-45deg, #1e3a8a, #2563eb, #3b82f6, #1d4ed8);
            --accent: #2563eb; 
            --success: #10b981; 
            --danger: #ef4444; 
            --bg-body: #f1f5f9;
            --text-dark: #1e293b;
        }

        body { 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg-body); 
            margin: 0; padding: 20px; color: var(--text-dark);
        }

        /* --- HEADER & ANIMASI --- */
        header { 
            background: var(--primary-grad);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: white; padding: 25px 30px; border-radius: 12px 12px 0 0;
            border-bottom: 4px solid rgba(255,255,255,0.2);
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .running-text-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px; padding: 5px 15px; margin-top: 15px;
            overflow: hidden; white-space: nowrap; border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .running-text {
            display: inline-block; padding-left: 100%;
            animation: marquee 25s linear infinite;
            font-size: 11px; font-weight: 500; letter-spacing: 1px; text-transform: uppercase;
        }

        @keyframes marquee {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-100%, 0); }
        }

        /* --- NOTIFIKASI TOAST --- */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast {
            background: white; padding: 15px 20px; border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-bottom: 10px;
            display: flex; align-items: center; gap: 12px;
            transform: translateX(120%); transition: 0.4s; border-left: 5px solid #2563eb;
        }
        .toast.show { transform: translateX(0); }
        .toast-success { border-left-color: var(--success); }
        .toast-error { border-left-color: var(--danger); }

        /* --- LAYOUT UMUM --- */
        .container { max-width: 1280px; margin: auto; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .tab-nav { display: flex; background: #fff; padding: 0 20px; border-bottom: 1px solid #e2e8f0; }
        .tab-btn { padding: 15px 20px; border: none; background: none; cursor: pointer; font-weight: 600; color: #64748b; font-size: 13px; position: relative; }
        .tab-btn.active { color: var(--accent); border-bottom: 3px solid var(--accent); }
        .content { padding: 25px; }
        .card { border: 1px solid #e2e8f0; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .btn { padding: 8px 15px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; color: white; display: inline-flex; align-items: center; gap: 6px; font-size: 12px; }
        .btn-blue { background: #3b82f6; } .btn-green { background: #10b981; } .btn-red { background: #ef4444; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #e2e8f0; padding: 12px; text-align: left; font-size: 13px; }
        th { background: #f8fafc; }
        .hidden { display: none !important; }
        
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(15, 23, 42, 0.95); z-index: 10000; 
            display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

<div id="toastContainer" class="toast-container"></div>

<div id="loginOverlay">
    <div style="background: white; padding: 40px; border-radius: 15px; width: 350px; text-align: center;">
        <h2 style="margin-top: 0;">ADMIN LOGIN</h2>
        <input type="email" id="loginEmail" placeholder="Email" style="width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box;">
        <input type="password" id="loginPass" placeholder="Password" style="width: 100%; padding: 10px; margin-bottom: 20px; box-sizing: border-box;">
        <button class="btn btn-blue" style="width: 100%; justify-content: center;" onclick="handleLogin()">MASUK SISTEM</button>
        <p id="loginError" style="color: red; font-size: 12px; margin-top: 10px;"></p>
    </div>
</div>

<div class="container">
    <header>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <span style="font-size: 40px;">üèÜ</span>
                <div>
                    <h1 style="margin: 0; font-size: 22px;">TIM KKGO KECAMATAN MAJALENGKA</h1>
                    <p style="margin: 5px 0 0; opacity: 0.8; font-size: 13px;">Aplikasi Pembuat Soal STS/SAS/US 2025/2026</p>
                </div>
            </div>
            <div style="text-align: right;">
                <div id="displayUserName" style="font-size: 12px; font-weight: bold; margin-bottom: 5px;">Memuat...</div>
                <button class="btn btn-red" onclick="handleLogout()" style="font-size: 10px; padding: 4px 10px;">LOGOUT</button>
            </div>
        </div>

        <div class="running-text-container">
            <div class="running-text">
                Selamat Datang di Portal KKGO Majalengka ‚Ä¢ Tingkatkan Kualitas Evaluasi Belajar Peserta Didik ‚Ä¢ Gunakan Fitur Cetak Word untuk mempermudah administrasi ‚Ä¢ Pastikan Data TP sudah sesuai dengan Kurikulum Merdeka.
            </div>
        </div>
    </header>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab(event, 'kurikulum')">üìÇ DATA KURIKULUM</button>
        <button class="tab-btn" onclick="switchTab(event, 'banksoal')">üìù BANK SOAL</button>
        <button id="btnTabUser" class="tab-btn hidden" onclick="switchTab(event, 'tabUser')">üë§ KELOLA GURU</button>
    </div>

    <div class="content">
        <div class="card" style="display: flex; gap: 20px; align-items: center; background: #f8fafc;">
            <div>
                <label style="font-size: 11px; font-weight: bold; display: block;">LOGO KOP SEKOLAH:</label>
                <input type="file" id="fLogoInstansi" accept="image/*" onchange="saveLogoToLocal(this)">
            </div>
            <div id="pvLogoKop" style="width: 60px; height: 60px; border: 1px dashed #ccc; display: flex; align-items: center; justify-content: center; overflow: hidden; background: white;">
                <small style="font-size: 8px;">NO LOGO</small>
            </div>
        </div>

        <div id="kurikulum" class="tab-content">
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                <h3>Repositori CP & TP</h3>
                <button class="btn btn-green" onclick="openFormKur()">+ TAMBAH DATA</button>
            </div>
            <div id="formKur" class="card hidden">
                <input type="text" id="fCp" placeholder="Capaian Pembelajaran" style="width: 100%; padding: 10px; margin-bottom: 10px;">
                <button class="btn btn-blue" onclick="saveKur()">SIMPAN</button>
                <button class="btn btn-red" onclick="closeForm('formKur')">BATAL</button>
            </div>
            <table>
                <thead><tr><th>Fase</th><th>Kelas</th><th>CP/Materi</th><th>Aksi</th></tr></thead>
                <tbody id="tblKurBody"></tbody>
            </table>
        </div>

        <div id="banksoal" class="tab-content hidden">
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                <h3>Daftar Soal</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-blue" onclick="exportToWord()">üìÑ CETAK DOKUMEN (KOP OTOMATIS)</button>
                </div>
            </div>
            <p>Fitur pengelolaan soal muncul di sini...</p>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    // Konfigurasi Firebase (Gunakan milik Anda)
    const firebaseConfig = {
        apiKey: "AIzaSyD3QnhV3PzzCKYxpt2JMapdhCZADApAmic",
        authDomain: "pjok-majalengka.firebaseapp.com",
        databaseURL: "https://pjok-majalengka-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "pjok-majalengka",
        appId: "1:996966252466:web:182de1ccd581fe0747aeab"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // --- SISTEM NOTIFIKASI ---
    window.showNotify = (msg, type = 'success') => {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `<span>${type === 'success' ? '‚úÖ' : '‚ùå'}</span><div class="toast-content">${msg}</div>`;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    };

    // --- AUTHENTICATION ---
    window.handleLogin = () => {
        const email = document.getElementById('loginEmail').value;
        const pass = document.getElementById('loginPass').value;
        signInWithEmailAndPassword(auth, email, pass).catch(err => {
            document.getElementById('loginError').innerText = "Login Gagal: Periksa Email/Password";
        });
    };

    window.handleLogout = () => { if(confirm("Keluar?")) signOut(auth); };

    onAuthStateChanged(auth, (user) => {
        const overlay = document.getElementById('loginOverlay');
        if (user) {
            overlay.style.display = 'none';
            document.getElementById('displayUserName').innerText = user.email;
            showNotify("Selamat Datang Kembali!", "success");
        } else {
            overlay.style.display = 'flex';
        }
    });

    // --- LOGO KOP LOGIC ---
    window.saveLogoToLocal = async (input) => {
        if(input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result;
                localStorage.setItem('pjok_logo_kop', base64);
                renderLogoKop(base64);
                showNotify("Logo Kop Berhasil Disimpan!");
            };
            reader.readAsDataURL(input.files[0]);
        }
    };

    function renderLogoKop(base64) {
        const pv = document.getElementById('pvLogoKop');
        if(base64) pv.innerHTML = `<img src="${base64}" style="width:100%; height:100%; object-fit:contain;">`;
    }
    renderLogoKop(localStorage.getItem('pjok_logo_kop'));

    // --- TAB NAVIGATION ---
    window.switchTab = (evt, name) => {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(name).classList.remove('hidden');
        evt.currentTarget.classList.add('active');
    };

    window.openFormKur = () => document.getElementById('formKur').classList.remove('hidden');
    window.closeForm = (id) => document.getElementById(id).classList.add('hidden');

    // --- WORD EXPORT WITH AUTOMATIC KOP ---
    window.exportToWord = async () => {
        showNotify("Menyiapkan Dokumen...", "info");
        const logoBase64 = localStorage.getItem('pjok_logo_kop');
        let logoImage;

        if (logoBase64) {
            const imageBuffer = Uint8Array.from(atob(logoBase64.split(',')[1]), c => c.charCodeAt(0));
            logoImage = new docx.ImageRun({
                data: imageBuffer,
                transformation: { width: 60, height: 60 },
            });
        }

        const doc = new docx.Document({
            sections: [{
                children: [
                    // TABLE KOP
                    new docx.Table({
                        width: { size: 100, type: docx.WidthType.PERCENTAGE },
                        borders: { bottom: { style: docx.BorderStyle.DOUBLE, size: 3 }, top: {style: docx.BorderStyle.NONE}, left: {style: docx.BorderStyle.NONE}, right: {style: docx.BorderStyle.NONE} },
                        rows: [new docx.TableRow({
                            children: [
                                new docx.TableCell({
                                    width: { size: 20, type: docx.WidthType.PERCENTAGE },
                                    children: [new docx.Paragraph({ children: [logoImage || []], alignment: docx.AlignmentType.CENTER })],
                                    borders: {bottom: {style: docx.BorderStyle.NONE}}
                                }),
                                new docx.TableCell({
                                    width: { size: 80, type: docx.WidthType.PERCENTAGE },
                                    children: [
                                        new docx.Paragraph({ text: "PEMERINTAH KABUPATEN MAJALENGKA", bold: true, alignment: docx.AlignmentType.CENTER }),
                                        new docx.Paragraph({ text: "DINAS PENDIDIKAN KECAMATAN MAJALENGKA", bold: true, alignment: docx.AlignmentType.CENTER }),
                                        new docx.Paragraph({ text: "KKGO KECAMATAN MAJALENGKA", bold: true, alignment: docx.AlignmentType.CENTER }),
                                        new docx.Paragraph({ text: "Sekretariat: Jl. KH Abdul Halim No. 123 Majalengka", size: 16, alignment: docx.AlignmentType.CENTER }),
                                    ],
                                    borders: {bottom: {style: docx.BorderStyle.NONE}}
                                })
                            ]
                        })]
                    }),
                    new docx.Paragraph({ text: "", spacing: { before: 200 } }),
                    new docx.Paragraph({ text: "NASKAH SOAL EVALUASI BELAJAR", alignment: docx.AlignmentType.CENTER, bold: true }),
                    new docx.Paragraph({ text: "Mata Pelajaran: PJOK", alignment: docx.AlignmentType.CENTER }),
                ]
            }]
        });

        docx.Packer.toBlob(doc).then(blob => {
            saveAs(blob, "Soal_PJOK_Majalengka.docx");
            showNotify("Dokumen Berhasil Diunduh!");
        });
    };
</script>

</body>
</html>
